name: Documentation Tests

on:
    pull_request:
        branches:    
            - dev_stage
            - main

jobs:

    sphinx:
        runs-on: windows-2019
        strategy:
          max-parallel: 0
          matrix:
            python-version: ['3.10']
    
        steps:
        - uses: actions/checkout@v2
        - name: Set up Python ${{ matrix.python-version }}
          uses: actions/setup-python@v2
          with:
            python-version: ${{ matrix.python-version }}
        - uses: actions/checkout@v2
          with: # for github push action
            #persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
            fetch-depth: 0 # otherwise, you will failed to push refs to dest repo
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install flake8 pytest
    
        - name: Install documentation dependencies
          run: |
            pip install sphinx numpydoc matplotlib         
    
        - name: Configure cmake
          run: |
              cmake -S src -B build -G "Visual Studio 16 2019" -A x64 ^
                -DCMAKE_INSTALL_PREFIX="build/Python" ^
                -DDHARTAPI_EnablePython="True"
                ...
        
        - name: Build
          run: cmake --build build --config Release
        
        - name: Install
          run: cmake --install build --config Release
        
        - name: pip install
          run: |
            cd build/Python
            python -m pip install --upgrade pip
            python -m pip install .

        - name: Check installed package
          run: |
            pip show dhart
            python -c "import platform; print(platform.architecture())"
            python -c "import dhart; print(dhart.__file__)"
          
        - name: Build documentation with sphinx
          run: |
            cd "docs/Python Docs"
            ls
            ./make.bat clean
            ./make.bat html
            # make latexpdf
            cd build
            ls
            cd html
            ls
    
        - name: Run sphinx doctests
          run: |
            cd "docs/Python Docs"
            ls
            ./make.bat clean
            ./make.bat doctest
    
        - name: Run pytest
          run: |
            cd "build/Python"
            ls
            pytest --doctest-modules --ignore-glob="*/Rhino*.py"